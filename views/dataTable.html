<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/table.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
  </head>
  
  <body>
    <div class = "search-tutor">
      <form id="searchTutor">
        <div class = "search_bar">
          <h2>
            Cerca un Tutor
          </h2>
          <input class = "" type = "text" id = "searchValue" placeholder = "Cerca">
          <button class = "btnSearch" type="button" onclick="searchTutors()" id="btnSearch"> <i class="material-icons">person_search</i></button><br>
          <input type="button" onclick="setFilter(1)" value="Nome" />
          <input type="button" onclick="setFilter(4)" value="Cognome" />
          <input type="button" onclick="setFilter(2)" value="Università" />
          <input type="button" onclick="setFilter(3)" value="Corso" />
        </div>  

        <table class = "table" id = "tableThead">
            <tr>
              <th>Nome</th>
              <th>Cognome</th>
              <th>Email</th>
              <th>Università</th>
              <th>Corso</th>
              <th>Esami</th>
            </tr>

            <tbody id="myTable">

            </tbody>
        </table>
      </form>
    </div>
    
    <! Calcellazione di un nuovo tutor nel database>
    <div class = "delete-tutor">
      <h2>
        Calcellazione dati Tutor
      </h2>
    
      <form action="" id="deleteTutor">
        <label for= "search"> ID Tutor</label><br>
        <input type="number" id="idTutor" name="idTutor" placeholder = "Inserisci ID tutor" >
        <button type="button" id="deleteValue" onclick= "deleteTutor()" >Cancella</button>
      </form>
    </div>
    <hr>
    
    <! Aggiornamento tutor dati tutor>
    <div class = "update-tutor">
      <h2>
        Aggiornamento dati Tutor
      </h2>
      <form id = "updateTutor">
        <label for="id">ID Tutor</label><br>
        <input type="number" id="id" name="id" placeholder = "Inserisci ID tutor" >
      
        <div>
          <label for="id">Modifica</label>
          <button type="button" id="filterByEmail" onclick= "setEmailFilter()">Email</button>
          <button type="button" id="filterByExam" onclick= "setExamFilter()">Nuovo Esame</button>
        </div>
        <input type="text" id="valore" name="valore" placeholder = "Inserisci modifica" >
        <button type="button" id="changeValue" onclick= "updateTutor()" >Modifica</button>
      </form>
    </div>
    
  </body>

  <script>
    var myArray = []
    //valori di default nel momento del caricamento della pagina
    localStorage.setItem("defaultFilter", 0);
    localStorage.setItem("defaultSearchValue", " ");
    
    sessionStorage.setItem("filter", localStorage.defaultFilter);
    sessionStorage.setItem("searchValue", "none ");
    
    $.ajax({
      method:'GET',
      url:'https://progetto-piattaforme-territorio.glitch.me/printAll' ,
      success: function(response){
        myArray = response;
        buildTable(myArray);
        console.log(myArray)
      }
    })
    
    //FUNZIONE PER RICERCARE UN TUTOR
    async function searchTutors(){
      sessionStorage.setItem("searchValue", document.getElementById("searchValue").value);
      
      if(!searchValue){
        alert("Inserire uno tutor.");
        return;
      }
      
      //opzioni per la fetch
      const options = {
        method: 'GET',
        headers: {
        'Content-Type': 'application/json',
        }
      };
      
      //eseguo la fetch
      fetch('https://progetto-piattaforme-territorio.glitch.me/home/searchTutors/'+sessionStorage.filter+'/'+ sessionStorage.searchValue, options)
      .then((response) => {
        if (response.ok) {
          alert("La ricerca ha prodotto risultati!");
          return response.json();
        }
        alert('ERROR!Something went wrong!');
      })
      .then(data =>{
        if(data > 0){
          myArray = data;
          buildTable(myArray);
          console.log(myArray)
        }
      })
      .catch(e => {
          console.log(e);
      });
      //pulisce la form
      document.getElementById("searchTutor").reset();
    }
    
    function setFilter(value){
      sessionStorage.setItem("filter", value);
    }
    
    function setSearchValue(){
      sessionStorage.setItem("searchValue",document.getElementById("searchValue").value );
    }

    function buildTable(data){
      var table = document.getElementById('myTable')
      $("#myTable").empty();

      for (var i = 0; i < data.length; i++){
        var row = `<tr>
                <td>${data[i].name}</td>
                <td>${data[i].surname}</td>
                <td>${data[i].email}</td>
                <td>${data[i].universita}</td>
                <td>${data[i].corso}</td>
                <td><button value = data[i].id onclick="deleteTutor(this.value)" <i class="material-symbols-outlined"> keyboard_double_arrow_right</td>
              </tr>`
        table.innerHTML += row;
      }
    }
    
    // FUNZIONE PER ELIMINARE UN TUTOR 
    async function deleteTutor(idTutor){
      //opzioni per la fetch
      const options = {
        method: 'DELETE'
      };
      console.log(idTutor);
      //eseguo la fetch
      fetch('https://progetto-piattaforme-territorio.glitch.me/home/deleteTutor/'+ idTutor, options)
      .then((response) => {
        if (response.ok) {
          alert("Tutor eliminato!");
          return response.json();
        }
        alert('ERROR '+ response.status +'! Something went wrong!');
        //invio al client la risposta sotto formato json
        response.json();
      })
      .then(data =>{
        if(data > 0){
          myArray = data;
          buildTable(myArray);
          console.log(myArray)
        }
      })
      .catch(e => {
          console.log(e);
      });
    }

  </script>
</html>
    